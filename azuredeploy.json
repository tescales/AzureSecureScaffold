{
  "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "nameRoot": {
      "type": "string",
      "metadata": {
        "description": "Name of the virtual machine"
      },
      "defaultValue": "[skip(uniqueString(subscription().subscriptionId), 3)]"
    },
    "subscriptionId": {
      "type": "string",
      "metadata": {
        "description": "your Azure subscription Id"
      },
      "defaultValue": "[subscription().subscriptionId]"
    },
      "ghURL": {
        "type": "string",
        "metadata": {
          "description": "Your GitHub repo"
        },
        "defaultValue": "https://raw.githubusercontent.com/tescales/azure-scaffold/master/"
      },
      "aadappname": {
        "type": "string",
        "metadata": {
          "description": "name of aad app"
        }
      },
      "aadClientID": {
        "type": "string",
        "metadata": {
          "description": "Client ID of AAD app which has permissions to KeyVault"
        }
      },
      "aadClientSecret": {
        "type": "securestring",
        "metadata": {
          "description": "Client Secret of AAD app which has permissions to KeyVault"
        }
      },
      "aadTenantId": {
        "type": "string",
        "metadata": {
          "description": "AzureAD TenantId"
        }
      },
      "useExistingKek": {
        "type": "string",
        "defaultValue": "nokek",
        "allowedValues": [
          "nokek",
          "kek"
        ],
        "metadata": {
          "description": "Select kek if the secret should be encrypted with a key encryption key and pass explicit keyEncryptionKeyURL. For nokek, you can keep keyEncryptionKeyURL empty."
        }
      },
      "keyEncryptionKeyURL": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "URL of the KeyEncryptionKey used to encrypt the volume encryption key"
        }
      }
    },
  "variables": {
    "automationName": "[concat('aa-', skip(parameters('nameRoot'), 3) )]",
    "automationUser": "username",
    "automationPass": "password",
    "keyVaultName": "[concat('kv-',skip(parameters('nameRoot'), 3) )]",
    "keyVaultURL": "[concat('https://', variables('keyVaultName'), '.vault.azure.net/')]",
    "keyVaultResourceID": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.KeyVault/vaults/', variables('keyVaultName'))]",
    "setupChocolatelyScriptLocation": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/visual-studio-dev-vm-chocolatey/scripts/",
    "setupChocolateyScriptFileName": "SetupChocolatey.ps1",
    "chocoPackages": "boxstarter,googlechrome,adobereader,notepadplusplus.install",
    "chocoScript": "https://chocolatey.org/install.ps1",
    "chocoScriptFile": "install.ps1"
  },

    "resources": [
      {
        "name": "[variables('automationName')]",
        "type": "Microsoft.Automation/automationAccounts",
        "apiVersion": "2015-10-31",
        "location": "[resourceGroup().location]",
        "dependsOn": [],
        "tags": {},
        "properties": {
          "sku": {
            "name": "Free"
          }
        }
      },
      {
        "apiVersion": "2015-01-01",
        "name": "jobGuid",
        "type": "Microsoft.Resources/deployments",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "https://raw.githubusercontent.com/davidjrh/azurerm-newguid/master/NewGuid.json",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "seed": { "value": "123" }
          }
        }
      },
      {
        "name": "DeployKeyVault",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(parameters('ghURL'), '/templates/keyvault/azuredeploy.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "keyVaultName": {
              "value": "[variables('keyVaultName')]"
            },

            "tenantId": {
              "value": "[parameters('aadTenantId')]"
            },

            "accessPolicies": {
              "value": [
                {
                  "tenantId": "[parameters('aadTenantId')]",
                  "objectId": "[parameters('aadClientID')]",
                  "displayname": "[parameters('aadappname')]",
                  "permissions": {
                    "keys": [ "all" ],
                    "secrets": [ "all" ]
                  }
                }
              ]
            },
            "secrets": {
              "value": [
                {
                  "secretName": "ConnectionString",
                  "secretValue": "SecureString1"
                }
              ]
            },
            "enabledForDeployment": {
              "value": true
            },

            "enabledForTemplateDeployment": {
              "value": true
            },
            "enableVaultForVolumeEncryption": {
              "value": true
            }
          }
        }
      },
      {
        "name": "DeployAutomationPS",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": [
          "[concat('Microsoft.Automation/automationAccounts/', variables('automationName'))]"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(parameters('ghURL'), '/templates/automation/azuredeploy.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "accountName": { "value": "[variables('automationName')]" },
            "regionId": { "value": "East US 2" },
            "userName": { "value": "[parameters('aadClientID')]" },
            "password": { "value": "[parameters('aadClientSecret')]" },
            "subscriptionIdValue": { "value": "[parameters('subscriptionId')]" },
            "runbookJobGuid": { "value": "[concat('rjg', skip(reference('jobGuid').outputs.guid.value, 3))]" },
            "scheduleLinkGuid": { "value": "[concat('sli', skip(reference('jobGuid').outputs.guid.value, 3))]" }
          }
        }
      },
      {
        "name": "DeployDSCAutomation",
        "type": "Microsoft.Resources/deployments",
        "apiVersion": "2015-01-01",
        "dependsOn": [
          "[concat('Microsoft.Automation/automationAccounts/', variables('automationName'))]"
        ],
        "properties": {
          "mode": "Incremental",
          "templateLink": {
            "uri": "[concat(parameters('ghURL'), '/templates/dsc/azuredeploy.json')]",
            "contentVersion": "1.0.0.0"
          },
          "parameters": {
            "accountName": { "value": "[variables('automationName')]" },
            "configurationName": { "value": "InstallChoco" },
            "configurationUri": { "value": "https://raw.githubusercontent.com/tescales/devDesktop/master/installChoco.ps1" },
            "configurationDescription": { "value": "Installs Chocolatey" },
            "jobId": { "value": "[concat('dsc', skip(reference('jobGuid').outputs.guid.value, 3))]" }
          }
        }
      }
    ]
  }
