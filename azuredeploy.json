{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "nameRoot": {
      "type": "string",
      "metadata": {
        "description": "Name of the virtual machine"
      },
      "defaultValue": "[concat('vm-', take(resourceGroup().name,12))]"
    },
    "subscriptionId": {
      "type": "string",
      "metadata": {
        "description": "Your Azure Subscription Id"
      },
      "defaultValue": "[subscription().subscriptionId]"
    },
    "gitHubUser": {
      "type": "string",
      "metadata": {
        "description": "Your GitHub username"
      },
      "defaultValue": "tescales"
    },
    "gitHubRepo": {
      "type": "string",
      "metadata": {
        "description": "Your GitHub username"
      },
      "defaultValue": "azure-scaffold"
    },
    "userObjectId": {
      "type": "string",
      "metadata": {
        "description": "Your User ObjectId"
      }
    },
    "aadTenantId": {
      "type": "string",
      "metadata": {
        "description": "Your AzureAD TenantId"
      },
      "defaultValue": "[subscription().tenantId]"
    }
  },
  "variables": {
    "ghURL": "[concat('https://raw.githubusercontent.com/', parameters('gitHubUser'), '/', parameters('gitHubRepo'), '/master')]",
    "storageAccountName": "[take(toLower( replace( concat( resourceGroup().name, 'scrt'), '-', '') ),23)]",
    "storageAccountShare": "scripts",
    "automationName": "[parameters('nameRoot')]",
    "automationUser": "username",
    "automationPass": "password",
    "keyVaultName": "[parameters('nameRoot')]",
    "keyVaultDeployUri": "[concat(variables('ghURL'), '/templates/keyvault/azuredeploy.json')]",
    "keyVaultURL": "[concat('https://', variables('keyVaultName'), '.vault.azure.net/')]",
    "keyVaultResourceID": "[concat(subscription().id,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.KeyVault/vaults/', variables('keyVaultName'))]",
    "regionId": "[resourceGroup().location]",
    "automationAcctDeployUri": "[concat(variables('ghURL'), '/templates/automation/azuredeploy.json')]",
    "dscDeployUri": "[concat(variables('ghURL'), '/templates/dsc/azuredeploy.json')]",
    "setupChocolatelyScriptLocation": "https://raw.githubusercontent.com/Azure/azure-quickstart-templates/master/visual-studio-dev-vm-chocolatey/scripts/",
    "setupChocolateyScriptFileName": "SetupChocolatey.ps1",
    "chocoPackages": "boxstarter,googlechrome,adobereader,notepadplusplus.install",
    "chocoScript": "https://chocolatey.org/install.ps1",
    "chocoScriptFile": "install.ps1"
  },
  "resources": [
    {
      "name": "[variables('StorageAccountName')]",
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2018-02-01",
      "location": "[resourceGroup().location]",
      "tags": {
        "description": "Used for Script Storage"
      },
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {}
    },
    {
      "name": "az-cli",
      "type": "Microsoft.ContainerInstance/containerGroups",
      "apiVersion": "2018-07-01",
      "location": "[resourcegroup().location]",
      "dependsOn": [
        "[variables('storageAccountName')]"
      ],
      "comments": "",
      "properties": {
        "containers": [
          { 
            "name": "bootstrapper",
            "properties": {
              "image": "microsoft/azure-cli",
              "command": [
                "bash",
                "-c",
                "[concat('/code/', parameters('gitHubRepo'), '/bootstrap/bootstrap.sh')]"
              ],
              "volumeMounts": [
                {
                  "name": "git-volume",
                  "mountPath": "/code"
                }
              ],
              "environmentVariables": [
                {
                  "name": "AZURE_STORAGE_KEY",
                  "securevalue": "[listKeys(variables('storageAccountName'),'2017-10-01').keys[0].value]"
                },
                {
                  "name": "AZURE_STORAGE_ACCOUNT",
                  "value": "[variables('storageAccountName')]"
                }
              ],
              "resources": {
                "requests": {
                  "cpu": "1",
                  "memoryInGb": "1"
                }
              }
            }
          }
        ],
        "restartPolicy": "OnFailure",
        "osType": "Linux",
        "volumes": [
          {
            "name": "git-volume",
            "gitRepo": {
              "repository": "[concat('https://github.com/', parameters('gitHubUser'), '/', parameters('gitHubRepo'))]"
            }
          }
        ]
      }
    },
    {
      "name": "[variables('automationName')]",
      "type": "Microsoft.Automation/automationAccounts",
      "apiVersion": "2015-10-31",
      "location": "[resourceGroup().location]",
      "tags": {},
      "properties": {
        "sku": {
          "name": "Free"
        }
      }
    },
    {
      "name": "DeployAutomationAcct",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('Microsoft.Automation/automationAccounts/', variables('automationName'))]",
        "[variables('keyVaultName')]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('automationAcctDeployUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "accountName": {
            "value": "[variables('automationName')]"
          },
          "userName": {
            "value": "[parameters('userObjectId')]"
          },
          "password": {
            "value": "secret"
          },
          "subscriptionId": {
            "value": "[parameters('subscriptionId')]"
          },
          "runbooks": {
            "value": [
              {
                "name": "StartAzureV2VMs",
                "runboookType": "Graph",
                "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Start-Azure-ARM-VMs-66fb875d/file/162482/1/StartAzureV2Vm.graphrunbook",
                "description": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and starts all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time."
              },
              {
                "name": "StopAzureV2VMs",
                "runboookType": "Graph",
                "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Stop-Azure-ARM-VMs-1ba96d5b/file/162480/1/StopAzureV2Vm.graphrunbook",
                "description": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and stops all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time."
              },
              {
                "name": "Register-VMDSC",
                "runboookType": "Graph",
                "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Registers-Azure-resource-31979771/file/160035/1/Register-VMDSC.graphrunbook",
                "description": "This runbook registers Azure resource manager virtual machines with automation DSC service. These can either be Windows or Linux virtual machines that are supported with DSC. You can specify the whole subscription, a specific resource group, or an individual VM."
              },
              {
                "name": "New-HybridWorkerAndAzureVM",
                "runboookType": "PowerShell",
                "Uri": "https://raw.githubusercontent.com/azureautomation/runbooks/master/Utility/ARM/New-HybridWorkerAndAzureVM.ps1",
                "description": "This Azure/OMS Automation runbook creates a new VM and onboards it as a hybrid worker.",
                "credentialName": "AzureCredential",
                "variableName": "AzureSubscriptionId",
                "variableType": "string"
              }
            ]
          },
          "runnowbooks": {
            "value": [
              {
                "name": "AutoTagResources-generic",
                "runboookType": "Script",
                "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Automatically-Azure-fc5f1443/file/165796/1/AutoTagResources-generic.ps1",
                "description": "An Azure Automation Runbook, to automatically tag Azure Resource Groups with the owner alias."
              }
            ]
          }
        }
      }
    },
    {
      "name": "DeployDSCAutomation",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2015-01-01",
      "dependsOn": [
        "[concat('Microsoft.Automation/automationAccounts/', variables('automationName'))]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('dscDeployUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "accountName": {
            "value": "[variables('automationName')]"
          },
          "configurations": {
            "value": [
              {
                "name": "InstallChoco",
                "description": "Installs Chocolatey",
                "uri": "https://raw.githubusercontent.com/tescales/azure-scaffold/master/configurations/installChoco.ps1"
              }
            ]
          },
          "modules": {
            "value": [
              {
                "name": "cChoco",
                "uri": "https://devopsgallerystorage.blob.core.windows.net/packages/cchoco.2.3.1.nupkg"
              }
            ]
          }
        }
      }
    }
  ],
  "outputs": {}
}