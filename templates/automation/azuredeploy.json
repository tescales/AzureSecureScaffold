{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "accountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Automation account to deploy to."
      }
    },
    "regionId": {
      "type": "string",
      "allowedValues": [
        "Japan East",
        "East US 2",
        "West Europe",
        "Southeast Asia",
        "South Central US"
      ],
      "metadata": {
        "description": "The region to deploy the Automation account in."
      }
    },

    "userName": {
      "type": "string",
      "metadata": {
        "description": "The username for the Azure Automation credential."
      }
    },
    "password": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Azure Automation credential."
      }
    },
    "runbooks": {
      "type": "array",
      "defaultvalue": []
      },
      "scheduleLinkGuid": {
        "type": "string",
        "metadata": {
          "description": "GUID for the schedule link to runbook.",
          "control": "guid"
        }
      },
      "runbookJobGuid": {
        "type": "string",
        "metadata": {
          "description": "GUID for the runbook job.",
          "control": "guid"
        }
      },
      "subscriptionIdValue": {
        "type": "string",
        "metadata": {
          "description": "Your Azure subscription ID."
        }
      }
    },

    "variables": {
      "pricingTier": "Free",
      "credentialName": "AzureCredential",
      "variableName": "AzureSubscriptionId",
      "variableType": "string"

    },
    "resources": [

      {
        "name": "[parameters('accountName')]",
        "type": "Microsoft.Automation/automationAccounts",
        "apiVersion": "2015-10-31",
        "location": "[parameters('regionId')]",
        "dependsOn": [],
        "tags": {},
        "properties": {
          "sku": {
            "name": "[variables('pricingTier')]"
          }
        },
        "resources": [
          
          {
            "name": "[variables('credentialName')]",
            "type": "credentials",
            "apiVersion": "2015-01-01-preview",
            "location": "[parameters('regionId')]",
            "dependsOn": [
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
            ],
            "tags": {},
            "properties": {
              "userName": "[parameters('userName')]",
              "password": "[parameters('password')]"
            }
          },
          {
            "name": "[variables('variableName')]",
            "type": "variables",
            "apiVersion": "2015-01-01-preview",
            "location": "[parameters('regionId')]",
            "dependsOn": [
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
            ],
            "tags": {
            },
            "properties": {
              "description": "Subscription ID for the Azure account to manage.",
              "isEncrypted": 0,
              "type": "[variables('variableType')]",
              "value": "[concat('\"',parameters('subscriptionIdValue'),'\"')]"
            }
          }
        ]
      },
      {
        "name": "[concat(parameters('accountName'), '/', parameters('runbooks')[copyIndex()].name)]",
        "type": "Microsoft.Automation/automationAccounts/runbooks",
        "apiVersion": "2015-10-31",
        "location": "[parameters('regionId')]",
        "dependsOn": [
          "[resourceId('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
        ],
        "tags": {
        },
        "properties": {
          "runbookType": "[parameters('runbooks')[copyIndex()].runboookType]",
          "description": "[parameters('runbooks')[copyIndex()].description]",
          "publishContentLink": {
            "uri": "[parameters('runbooks')[copyIndex()].Uri]",
            "version": "1.0.0.0"
          }
        },

        "copy": {
          "name": "deployRunbooks",
          "count": "[length(parameters('runbooks'))]"
        }
      }
    ],
    "outputs": {}
  }
