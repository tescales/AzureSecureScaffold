{
  "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "accountName": {
      "type": "string",
      "metadata": {
        "description": "The name of the Azure Automation account to deploy to."
      }
    },
    "regionId": {
      "type": "string",
      "allowedValues": [
        "Japan East",
        "East US 2",
        "West Europe",
        "Southeast Asia",
        "South Central US"
      ],
      "metadata": {
        "description": "The region to deploy the Automation account in."
      }
    },
    "subscriptionIdValue": {
      "type": "string",
      "metadata": { "description": "subscriptionID" }
    },
    "runbookJobGuid": {
      "type": "string",
      "metadata": { "description": "runbookJobGUID" }
    },

    "userName": {
      "type": "string",
      "metadata": {
        "description": "The username for the Azure Automation credential."
      }
    },
    "password": {
      "type": "securestring",
      "metadata": {
        "description": "The password for the Azure Automation credential."
      }
    },
    "runbooks": {
      "type": "array",
      "defaultvalue": [
        {
          "name": "StartAzureV2VMs",
          "type": "Graph",
          "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Start-Azure-ARM-VMs-66fb875d/file/162482/1/StartAzureV2Vm.graphrunbook",
          "description": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and starts all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time."
        },
        {
          "name": "StopAzureV2VMs",
          "type": "Graph",
          "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Stop-Azure-ARM-VMs-1ba96d5b/file/162480/1/StopAzureV2Vm.graphrunbook",
          "description": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and stops all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time."
        },
        {
          "name": "Register-VMDSC",
          "type": "Graph",
          "Uri": "https://gallery.technet.microsoft.com/scriptcenter/Registers-Azure-resource-31979771/file/160035/1/Register-VMDSC.graphrunbook",
          "description": "This runbook registers Azure resource manager virtual machines with automation DSC service. These can either be Windows or Linux virtual machines that are supported with DSC. You can specify the whole subscription, a specific resource group, or an individual VM."
        },
        {
          "name": "New-HybridWorkerAndAzureVM",
          "type": "PowerShell",
          "Uri": "https://raw.githubusercontent.com/azureautomation/runbooks/master/Utility/ARM/New-HybridWorkerAndAzureVM.ps1",
          "description": "This Azure/OMS Automation runbook creates a new VM and onboards it as a hybrid worker.",
          "credentialName": "AzureCredential",
          "variableName": "AzureSubscriptionId",
          "variableType": "string"
        }
      ]
      },
      "scheduleLinkGuid": {
        "type": "string",
        "metadata": {
          "description": "GUID for the schedule link to runbook.",
          "control": "guid"
        }
      },
      "runbookJobGuid": {
        "type": "string",
        "metadata": {
          "description": "GUID for the runbook job.",
          "control": "guid"
        }
      },
      "subscriptionIdValue": {
        "type": "string",
        "metadata": {
          "description": "Your Azure subscription ID."
        }
      }
    }
  },

    "variables": {
      "pricingTier": "Free",
      "startRunbookName": "StartAzureV2VMs",
      "startRunbookUri": "https://gallery.technet.microsoft.com/scriptcenter/Start-Azure-ARM-VMs-66fb875d/file/162482/1/StartAzureV2Vm.graphrunbook",
      "startRunbookType": "Graph",
      "startRunbookDescription": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and starts all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time.",
      "stopRunbookName": "StopAzureV2VMs",
      "stopRunbookUri": "https://gallery.technet.microsoft.com/scriptcenter/Stop-Azure-ARM-VMs-1ba96d5b/file/162480/1/StopAzureV2Vm.graphrunbook",
      "stopRunbookType": "Graph",
      "stopRunbookDescription": "This Graphical PowerShell runbook connects to Azure using an Automation Run As account and stops all V2 VMs in an Azure subscription or in a resource group or a single named V2 VM. You can attach a recurring schedule to this runbook to run it at a specific time",

      "registerDSCRunbookName": "Register-VMDSC",
      "registerDSCRunbookUri": "https://gallery.technet.microsoft.com/scriptcenter/Registers-Azure-resource-31979771/file/160035/1/Register-VMDSC.graphrunbook",
      "registerDSCRunbookType": "Graph",
      "registerDSCRunbookDescription": "This runbook registers Azure resource manager virtual machines with automation DSC service. These can either be Windows or Linux virtual machines that are supported with DSC. You can specify the whole subscription, a specific resource group, or an individual VM.",

      "newHWVMRunbookName": "New-HybridWorkerAndAzureVM",
      "newHWVMRunbookUri": "https://raw.githubusercontent.com/azureautomation/runbooks/master/Utility/ARM/New-HybridWorkerAndAzureVM.ps1",
      "newHWVMRunbookType": "PowerShell",
      "newHWVMRunbookDescription": "This Azure/OMS Automation runbook creates a new VM and onboards it as a hybrid worker.",
      "credentialName": "AzureCredential",
      "variableName": "AzureSubscriptionId",
      "variableType": "string"

    },
    "resources": [

      {
        "name": "[parameters('accountName')]",
        "type": "Microsoft.Automation/automationAccounts",
        "apiVersion": "2015-10-31",
        "location": "[parameters('regionId')]",
        "dependsOn": [],
        "tags": {},
        "properties": {
          "sku": {
            "name": "[variables('pricingTier')]"
          }
        },
        "resources": [
          {
            "name": "[parameters('runbookJobGuid')]",
            "type": "jobs",
            "apiVersion": "2015-01-01-preview",
            "location": "[resourceGroup().location]",
            "dependsOn": [
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]",
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'), '/runbooks/',variables('newHWVMRunbookName'))]"
            ],
            "tags": {
              "key": "value"
            },
            "properties": {
              "runbook": {
                "name": "[variables('newHWVMRunbookName')]"
              }
            }
          },
          {
            "name": "[variables('credentialName')]",
            "type": "credentials",
            "apiVersion": "2015-01-01-preview",
            "location": "[parameters('regionId')]",
            "dependsOn": [
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
            ],
            "tags": {},
            "properties": {
              "userName": "[parameters('userName')]",
              "password": "[parameters('password')]"
            }
          },
          {
            "name": "[variables('variableName')]",
            "type": "variables",
            "apiVersion": "2015-01-01-preview",
            "location": "[parameters('regionId')]",
            "dependsOn": [
              "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
            ],
            "tags": {
            },
            "properties": {
              "description": "Subscription ID for the Azure account to manage.",
              "isEncrypted": 0,
              "type": "[variables('variableType')]",
              "value": "[concat('\"',parameters('subscriptionIdValue'),'\"')]"
            }
          }
        ]
      },
      {
        "name": "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'), '/', parameters('runbooks')[copyIndex()].name)]",
        "type": "Microsoft.Automation/automationAccounts/runbooks",
        "apiVersion": "2015-10-31",
        "location": "[parameters('regionId')]",
        "dependsOn": [
          "[concat('Microsoft.Automation/automationAccounts/', parameters('accountName'))]"
        ],
        "tags": {
        },
        "properties": {
          "runbookType": "[parameters('runbooks')[copyIndex()].type]",
          "description": "[parameters('runbooks')[copyIndex()].description]",
          "publishedContentLink": {
            "uri": "[parameters('runbooks')[copyIndex()].Uri]",
            "version": "1.0.0.0"
          }
        },

        "copy": {
          "name": "deployScripts",
          "count": "[length(parameters('runbooks'))]"
        }
      }
    ],
    "outputs": {}
  }
